FROM buildpack-deps:focal-scm

# Provided automatically by docker buildx.
ARG TARGETPLATFORM
ARG BUILDPLATFORM

ENV TARGETPLATFORM=$TARGETPLATFORM
ENV PATH /usr/local/go/bin:/usr/local/protoc/bin:$PATH

COPY requirements.txt /tmp/requirements.txt
COPY boulder.rsyslog.conf /etc/rsyslog.d/
COPY build.sh /tmp/build.sh
RUN /tmp/build.sh

# Note: This arg and env variable should only be set _after_ build.sh installs
# necessary apt packages. Otherwise, we will reinstall those apt packages for
# each Go version, rather than reusing a cached layer.
ARG GO_VERSION
ENV GO_VERSION=$GO_VERSION
COPY install-go.sh /tmp/install-go.sh
COPY setup-govulncheck.sh /tmp/setup-govulncheck.sh
RUN /tmp/install-go.sh && \
    /tmp/setup-govulncheck.sh && \
    sed -i -e '/imklog/s/^/#/' -e '/$ActionFileDefaultTemplate/s/^/#/' -e '/$RepeatedMsgReduction on/s/^/#/' /etc/rsyslog.conf
